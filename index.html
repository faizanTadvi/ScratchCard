<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Your Discount! - Banjo Cafe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add confetti library --><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind gray-900 */
        }
        #main-content.no-scroll {
             touch-action: none;
        }
        /* Custom styles for the scratch card canvas */
        #scratch-card-canvas {
            cursor: grabbing;
            border-radius: 0.75rem; /* 12px */
            transition: opacity 0.3s ease-out; /* Smooth fade out */
        }
        #scratch-card-canvas.hidden-scratch {
            opacity: 0;
            pointer-events: none; /* Make it unclickable when hidden */
        }
        .task-item-completed {
            opacity: 0.5;
        }
        .task-item-completed .task-description {
            text-decoration: line-through;
        }
        /* Animation for modal popup */
        .modal-show {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-content-show {
             animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        /* Animation for result reveal */
        .result-reveal {
            animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Style for locked tasks */
        .task-item-locked {
            opacity: 0.6;
            cursor: not-allowed !important; /* Force cursor */
            background-color: #1f2937; /* gray-800 */
        }
        .task-item-locked:hover {
            border-color: #374151; /* gray-700, no special hover effect */
            box-shadow: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="main-content" class="w-full max-w-md mx-auto bg-gray-950/70 backdrop-blur-xl rounded-3xl shadow-2xl shadow-red-800/20 p-5 sm:p-6 md:p-8 text-center transition-all duration-500">

        <!-- Header Section --><header id="header-section">
            <img id="logo" src="kw.PNG" alt="Cafe Logo" class="w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-4 rounded-full shadow-lg border-4 border-white">
            <h1 id="restaurant-name" class="text-3xl sm:text-4xl font-bold text-gray-100">Restaurant Name</h1>
            <p class="text-gray-400 mt-2 text-base sm:text-lg">Complete a couple of tasks to unlock a surprise discount!</p>
        </header>

        <!-- Tasks Section --><div id="tasks-section" class="mt-8 space-y-3">
            <!-- Tasks will be dynamically inserted here --></div>
        
        <!-- Get Card Button Section (Initially hidden) --><div id="get-card-button-section" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-red-500 mb-2">Tasks Complete!</h2>
            <p class="text-gray-300 mb-6">You've unlocked your reward. Click below to claim it!</p>
            <button id="get-card-btn" class="bg-gradient-to-br from-red-600 to-red-800 text-white font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-lg w-full sm:w-auto">
                Get Your Scratch Card
            </button>
        </div>
        
        <!-- Already Claimed Section (Initially Hidden) --><div id="already-claimed-section" class="hidden mt-8 text-center">
            <h2 class="text-2xl font-bold text-red-500 mb-2">Welcome Back!</h2>
            <p class="text-gray-300 mb-4">You've already claimed a discount recently. Here's your code:</p>
            <p id="claimed-discount-code" class="text-2xl font-mono bg-gray-800 text-red-300 px-6 py-3 rounded-lg inline-block border border-gray-700"></p>
            <p class="text-sm text-gray-400 mt-4">This code is valid for 24 hours.</p>
        </div>

    </div>
    
    <!-- Scratch Card Modal (Initially Hidden) --><div id="scratch-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div id="scratch-card-section" class="bg-gray-900 rounded-3xl shadow-2xl p-5 sm:p-6 md:p-8 text-center w-full max-w-md relative">
            <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-500 hover:text-white text-4xl transition-colors">&times;</button>
            <h2 class="text-2xl font-bold text-red-500 mb-2">Congratulations!</h2>
            <p class="text-gray-400 mb-5">Scratch the card below to reveal your surprise!</p>
            <div id="scratch-card-container" class="w-full rounded-xl flex flex-col items-center justify-center bg-gradient-to-br from-gray-700 to-gray-800">
                <div id="scratch-area" class="relative w-full h-40 sm:h-48 md:h-56">
                    <!-- The revealed discount is under the canvas -->
                    <div id="result-text" class="absolute inset-0 flex flex-col items-center justify-center text-center opacity-0 p-2">
                        <p class="text-lg text-gray-300 font-medium">You've won a</p>
                        <h3 class="text-5xl sm:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-400 my-1"></h3>
                        <p class="text-sm text-gray-400 mt-2">Show this code to the cashier</p>
                        <p id="discount-code" class="mt-2 text-xl text-white font-mono tracking-widest bg-gray-700 px-4 py-2 rounded-lg inline-block border border-gray-600"></p>
                    </div>
                    <!-- The scratchable canvas is on top -->
                    <canvas id="scratch-card-canvas" class="absolute top-0 left-0 w-full h-full rounded-xl"></canvas>
                </div>

                 <!-- Referral Section (Initially Hidden) -->
                <div id="referral-section" class="hidden w-full p-4 pt-6 border-t border-gray-600">
                    <h4 class="text-lg font-bold text-white">Share for a bigger discount!</h4>
                    <p class="text-gray-400 text-sm mb-3">Share your link and your friends will get a better discount!</p>
                    <div class="relative flex items-center">
                        <input type="text" id="referral-link-display" readonly class="w-full bg-gray-800 border border-gray-600 text-gray-300 text-sm rounded-lg p-3 pr-24" value="">
                        <button id="copy-link-btn" class="absolute right-1 top-1/2 -translate-y-1/2 bg-red-600 hover:bg-red-700 text-white font-bold text-sm py-2 px-3 rounded-md transition-all">
                            Copy
                        </button>
                    </div>
                    <p id="copy-feedback" class="text-green-400 text-xs mt-2 h-4"></p>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // =================================================================
            // === CONFIGURATION: Edit these values for each restaurant ===
            // =================================================================
            const config = {
                restaurantName: "Hotel Khandesh Wada",
                 logoUrl: "kw.PNG", // Placeholder Logo
                tasks: [
                    {
                        name: "Google Review",
                        description: "Leave us a review on Google",
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="text-red-500"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12.5C5,8.75 8.36,5.73 12.19,5.73C15.19,5.73 17.55,6.82 17.55,6.82L19.43,5C19.43,5 17.55,3 12.19,3C6.42,3 2.03,7.8 2.03,12.5C2.03,17.2 6.42,22 12.19,22C17.6,22 21.7,18.35 21.7,12.91C21.7,12.16 21.55,11.6 21.35,11.1Z"/></svg>`,
                        url: "https://maps.app.goo.gl/SggpAD2sniLMkmeu6"
                    },
                    {
                        name: "Instagram Follow",
                        description: "Follow us on Instagram",
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stroke-red-500"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>`,
                        url: "https://www.instagram.com/hotelkhandeshwadajalgaon?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw=="
                    }
                ],
                // How long (in hours) until a user can get a new card. 24 is recommended.
                cooldownHours: 0,
                // Threshold for revealing and triggering confetti (0.0 to 1.0, e.g., 0.7 for 70%)
                revealThreshold: 0.3
            };
            // =================================================================
            // === End of Configuration ===
            // =================================================================
            const mainContent = document.getElementById('main-content');
            const tasksSection = document.getElementById('tasks-section');
            const getCardButtonSection = document.getElementById('get-card-button-section');
            const getCardBtn = document.getElementById('get-card-btn');
            const scratchModalOverlay = document.getElementById('scratch-modal-overlay');
            const scratchCardSection = document.getElementById('scratch-card-section');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const alreadyClaimedSection = document.getElementById('already-claimed-section');
            const headerSection = document.getElementById('header-section');
            const canvas = document.getElementById('scratch-card-canvas');
            const ctx = canvas.getContext('2d');
            const resultTextContainer = document.getElementById('result-text');
            const resultTextEl = document.querySelector('#result-text h3');
            const discountCodeEl = document.getElementById('discount-code');
            const referralSection = document.getElementById('referral-section');
            const referralLinkDisplay = document.getElementById('referral-link-display');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const copyFeedback = document.getElementById('copy-feedback');

            let tasksState = config.tasks.map(() => false);
            let scratchImageData, pixelData, totalPixels;

            function handleReferral() {
                const urlParams = new URLSearchParams(window.location.search);
                const refId = urlParams.get('ref');
                if (refId) {
                    // Mark this user as referred to give them a bonus
                    localStorage.setItem('isReferred', 'true');
                    // Clean the URL so the ref code isn't shared again
                    history.replaceState(null, '', window.location.pathname);
                }
            }
            
            function getUserId() {
                let userId = localStorage.getItem('userId');
                if (!userId) {
                    userId = Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
                    localStorage.setItem('userId', userId);
                }
                return userId;
            }

            function init() {
                handleReferral();
                const claimedData = getFromLocalStorage();
                if (claimedData) {
                    document.getElementById('claimed-discount-code').textContent = claimedData.code;
                    headerSection.classList.add('hidden');
                    tasksSection.classList.add('hidden');
                    alreadyClaimedSection.classList.remove('hidden');
                    return;
                }

                document.getElementById('restaurant-name').textContent = config.restaurantName;
                if(config.logoUrl) document.getElementById('logo').src = config.logoUrl;

                config.tasks.forEach((task, index) => {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'task-item bg-gray-800/80 p-4 border border-gray-700 rounded-xl flex items-center justify-between transition-all hover:shadow-md hover:border-red-500 cursor-pointer';
                    
                    if (index > 0) taskEl.classList.add('task-item-locked');

                    taskEl.innerHTML = `
                        <div class="flex items-center text-left flex-grow pointer-events-none">
                            <div class="mr-4">${task.icon}</div>
                            <span class="text-gray-200 font-medium task-description">${task.description}</span>
                        </div>
                        <input type="checkbox" data-index="${index}" class="h-6 w-6 rounded-md border-gray-600 text-red-600 focus:ring-red-500 cursor-not-allowed" disabled>
                    `;
                    tasksSection.appendChild(taskEl);

                    taskEl.addEventListener('click', (e) => {
                        if (taskEl.classList.contains('task-item-locked')) return;
                        const checkbox = taskEl.querySelector('input[type="checkbox"]');
                        if (checkbox.disabled) {
                            checkbox.disabled = false;
                            checkbox.classList.remove('cursor-not-allowed');
                            checkbox.classList.add('cursor-pointer');
                        }
                        if (e.target.type !== 'checkbox') {
                            window.open(task.url, '_blank');
                        }
                    });
                });

                document.querySelectorAll('#tasks-section input[type="checkbox"]').forEach(cb => cb.addEventListener('change', handleCheckboxChange));
                getCardBtn.addEventListener('click', showScratchModal);
                closeModalBtn.addEventListener('click', hideScratchModal);
                copyLinkBtn.addEventListener('click', copyReferralLink);
            }

            function handleCheckboxChange(event) {
                const index = parseInt(event.target.dataset.index);
                const isChecked = event.target.checked;
                tasksState[index] = isChecked;
                event.target.closest('.task-item').classList.toggle('task-item-completed', isChecked);

                const allTaskItems = document.querySelectorAll('.task-item');
                if (isChecked) {
                    const nextTaskItem = allTaskItems[index + 1];
                    if (nextTaskItem) nextTaskItem.classList.remove('task-item-locked');
                } else {
                    for (let i = index + 1; i < allTaskItems.length; i++) {
                        const itemToLock = allTaskItems[i];
                        const checkboxToLock = itemToLock.querySelector('input[type="checkbox"]');
                        itemToLock.classList.add('task-item-locked');
                        itemToLock.classList.remove('task-item-completed');
                        if (checkboxToLock.checked) {
                            checkboxToLock.checked = false;
                            tasksState[i] = false;
                        }
                        checkboxToLock.disabled = true;
                        checkboxToLock.classList.add('cursor-not-allowed');
                        checkboxToLock.classList.remove('cursor-pointer');
                    }
                }
                checkAllTasksCompleted();
            }

            function checkAllTasksCompleted() {
                if (tasksState.every(status => status === true)) {
                    setTimeout(() => {
                        tasksSection.classList.add('hidden');
                        getCardButtonSection.classList.remove('hidden');
                    }, 500);
                }
            }
            
            function showScratchModal() {
                scratchModalOverlay.classList.remove('hidden');
                scratchModalOverlay.classList.add('modal-show');
                scratchCardSection.classList.add('modal-content-show');
                mainContent.classList.add('no-scroll');
                setupScratchCard();
            }
            
            function hideScratchModal() {
                scratchModalOverlay.classList.add('hidden');
                scratchModalOverlay.classList.remove('modal-show');
                scratchCardSection.classList.remove('modal-content-show');
                mainContent.classList.remove('no-scroll');
                canvas.classList.remove('hidden-scratch');
                resultTextContainer.classList.add('opacity-0');
                resultTextContainer.classList.remove('result-reveal');
                referralSection.classList.add('hidden');
            }

            function generateDiscount(isReferred) {
                // Discount is capped at 5% for everyone
                const discount = Math.floor(Math.random() * 5) + 1; // 1% to 5%

                const uniquePart = Date.now().toString(36).slice(-4).toUpperCase();
                const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
                const code = `PROMO-${uniquePart}${randomPart}`;
                return { discount, code };
            }

            function setupScratchCard() {
                const isReferred = localStorage.getItem('isReferred') === 'true';
                const { discount, code } = generateDiscount(isReferred);
                resultTextEl.textContent = `${discount}% OFF`;
                discountCodeEl.textContent = code;
                saveToLocalStorage({ discount, code, timestamp: Date.now() });
                if(isReferred) localStorage.removeItem('isReferred'); // Use the bonus once

                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                ctx.globalCompositeOperation = 'source-over';
                
                const patternCanvas = document.createElement('canvas');
                const patternCtx = patternCanvas.getContext('2d');
                patternCanvas.width = 10; patternCanvas.height = 10;
                patternCtx.fillStyle = '#374151';
                patternCtx.fillRect(0, 0, 10, 10);
                patternCtx.fillStyle = '#4b5563';
                patternCtx.beginPath(); patternCtx.arc(2.5, 2.5, 1.5, 0, 2 * Math.PI); patternCtx.fill();
                patternCtx.beginPath(); patternCtx.arc(7.5, 7.5, 1.5, 0, 2 * Math.PI); patternCtx.fill();
                const pattern = ctx.createPattern(patternCanvas, 'repeat');
                ctx.fillStyle = pattern;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.font = '700 1.25rem Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Scratch Here to Reveal!', canvas.width / 2, canvas.height / 2);

                let isDrawing = false;
                let confettiFired = false;

                function getEventPosition(event) {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                    const clientY = event.touches ? event.touches[0].clientY : event.clientY;
                    return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
                }
                
                function revealCard() {
                    if (confettiFired) return;
                    resultTextContainer.classList.remove('opacity-0');
                    resultTextContainer.classList.add('result-reveal');
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                    canvas.classList.add('hidden-scratch');
                    
                    // Show referral link section
                    const userId = getUserId();
                    const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userId}`;
                    referralLinkDisplay.value = referralLink;
                    referralSection.classList.remove('hidden');

                    confettiFired = true;
                }

                function getScratchedPercentage() {
                    let scratchedPixels = 0;
                    const currentImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const currentPixelData = currentImageData.data;
                    for (let i = 0; i < currentPixelData.length; i += 4) {
                        if (currentPixelData[i + 3] === 0) scratchedPixels++;
                    }
                    return scratchedPixels / (currentImageData.width * currentImageData.height);
                }

                function scratch(e) {
                    if (!isDrawing) return;
                    e.preventDefault();
                    const pos = getEventPosition(e);
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, 30, 0, Math.PI * 2);
                    ctx.fill();

                    if (getScratchedPercentage() > config.revealThreshold) {
                        revealCard();
                    }
                }

                function startScratch(e) { 
                    isDrawing = true; 
                    if (e.type === 'touchstart') e.preventDefault();
                    scratch(e); 
                }
                
                function stopScratch() {
                    isDrawing = false;
                    if (!confettiFired && getScratchedPercentage() > config.revealThreshold * 0.5) {
                        revealCard();
                    }
                }
                
                ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, startScratch, { passive: false }));
                ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, scratch, { passive: false }));
                ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => canvas.addEventListener(evt, stopScratch));
            }
            
            function copyReferralLink() {
                // Fallback for older browsers/secure contexts
                const textArea = document.createElement("textarea");
                textArea.value = referralLinkDisplay.value;
                textArea.style.position = "fixed"; // Avoid scrolling to bottom
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyFeedback.textContent = 'Copied to clipboard!';
                } catch (err) {
                    copyFeedback.textContent = 'Failed to copy!';
                }
                document.body.removeChild(textArea);
                
                setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
            }

            function saveToLocalStorage(data) { localStorage.setItem('discountData', JSON.stringify(data)); }
            function getFromLocalStorage() {
                const dataStr = localStorage.getItem('discountData');
                if (!dataStr) return null;
                const data = JSON.parse(dataStr);
                const hoursSinceClaimed = (Date.now() - data.timestamp) / 3600000;
                if (hoursSinceClaimed < config.cooldownHours) return data;
                localStorage.removeItem('discountData');
                return null;
            }

            init();
        });
    </script>
</body>
</html>

