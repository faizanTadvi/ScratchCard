<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Your Discount! - Khandesh Wada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add confetti library --><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind gray-900 */
        }
        #main-content.no-scroll {
             touch-action: none;
        }
        #scratch-card-canvas {
            cursor: grabbing;
            border-radius: 0.75rem;
            transition: opacity 0.3s ease-out;
        }
        #scratch-card-canvas.hidden-scratch {
            opacity: 0;
            pointer-events: none;
        }
        .task-item-completed { opacity: 0.5; }
        .task-item-completed .task-description { text-decoration: line-through; }
        .modal-show { animation: fadeIn 0.3s ease-out forwards; }
        .modal-content-show { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .result-reveal { animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .task-item-locked {
            opacity: 0.6;
            cursor: not-allowed !important;
            background-color: #1f2937;
        }
        .task-item-locked:hover { border-color: #374151; box-shadow: none; }
        /* Final Discount Animation */
        .counter-animate {
            animation: counter-pop 0.4s ease-in-out;
        }
        @keyframes counter-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.25) rotate(5deg); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="main-content" class="w-full max-w-md mx-auto bg-gray-950/70 backdrop-blur-xl rounded-3xl shadow-2xl shadow-red-800/20 p-5 sm:p-6 md:p-8 text-center transition-all duration-500">
        
        <div id="loading-spinner" class="hidden text-white">Loading...</div>
        
        <!-- User Details Section (Initially visible for User A) -->
        <div id="user-details-section" class="hidden">
            <img id="logo-top" src="kw.PNG" alt="Cafe Logo" class="w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-4 rounded-full shadow-lg border-4 border-white">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-100">Welcome!</h1>
            <p class="text-gray-400 mt-2 mb-6 text-base sm:text-lg">Enter your details to begin.</p>
            <form id="user-details-form" class="space-y-4 text-left">
                <div>
                    <label for="user-name" class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                    <input type="text" id="user-name" name="name" required class="w-full bg-gray-800 border border-gray-600 text-gray-200 rounded-lg p-3 focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="user-contact" class="block text-sm font-medium text-gray-300 mb-1">Contact Number</label>
                    <input type="tel" id="user-contact" name="contact" required pattern="[0-9]{10}" title="Please enter a 10-digit contact number" class="w-full bg-gray-800 border border-gray-600 text-gray-200 rounded-lg p-3 focus:ring-red-500 focus:border-red-500">
                </div>
                <button type="submit" class="w-full bg-gradient-to-br from-red-600 to-red-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-lg !mt-6 flex items-center justify-center">
                    Continue
                </button>
            </form>
        </div>

        <!-- Header for Tasks (Shared by User A and User B) -->
        <header id="header-section" class="hidden">
            <img id="logo" src="kw.PNG" alt="Cafe Logo" class="w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-4 rounded-full shadow-lg border-4 border-white">
            <h1 id="restaurant-name" class="text-3xl sm:text-4xl font-bold text-gray-100">Restaurant Name</h1>
            <p id="header-subtitle" class="text-gray-400 mt-2 text-base sm:text-lg">Complete a couple of tasks to unlock a surprise discount!</p>
        </header>

        <div id="tasks-section" class="hidden mt-8 space-y-3"></div>
        
        <!-- Button for User A -->
        <div id="get-card-button-section" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-red-500 mb-2">Tasks Complete!</h2>
            <p class="text-gray-300 mb-6">You've unlocked your reward. Click below to claim it!</p>
            <button id="get-card-btn" class="bg-gradient-to-br from-red-600 to-red-800 text-white font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-lg w-full sm:w-auto">
                Get Your Scratch Card
            </button>
        </div>

        <!-- Button for User B -->
        <div id="boost-friend-section" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-green-500 mb-2">Tasks Complete!</h2>
            <p class="text-gray-300 mb-6">Thank you! Click the button below to help your friend get a bigger discount.</p>
            <button id="boost-btn" class="bg-gradient-to-br from-green-600 to-green-800 text-white font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-lg w-full sm:w-auto">
                Boost Friend's Discount!
            </button>
        </div>
        
        <!-- Already Claimed / Expired Messages -->
        <div id="info-section" class="hidden mt-8 text-center">
             <h2 id="info-title" class="text-2xl font-bold text-red-500 mb-2"></h2>
             <p id="info-message" class="text-gray-300 mb-4"></p>
             <p id="info-code" class="text-2xl font-mono bg-gray-800 text-red-300 px-6 py-3 rounded-lg inline-block border border-gray-700"></p>
        </div>
    </div>
    
    <!-- Scratch Card Modal for User A -->
    <div id="scratch-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div id="scratch-card-section" class="bg-gray-900 rounded-3xl shadow-2xl p-5 sm:p-6 md:p-8 text-center w-full max-w-md relative">
            <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-500 hover:text-white text-4xl transition-colors">&times;</button>
            <h2 class="text-2xl font-bold text-red-500 mb-2">Congratulations!</h2>
            <p class="text-gray-400 mb-5">Scratch the card below to reveal your surprise!</p>
            <div id="scratch-card-container" class="w-full rounded-xl flex flex-col items-center justify-center bg-gradient-to-br from-gray-700 to-gray-800">
                <div id="scratch-area" class="relative w-full h-40 sm:h-48 md:h-56">
                    <div id="result-text" class="absolute inset-0 flex flex-col items-center justify-center text-center opacity-0 p-2">
                        <p class="text-lg text-gray-300 font-medium">You've won a</p>
                        <h3 id="initial-discount-display" class="text-5xl sm:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-400 my-1"></h3>
                    </div>
                    <canvas id="scratch-card-canvas" class="absolute top-0 left-0 w-full h-full rounded-xl"></canvas>
                </div>
                
                <div id="bonus-section" class="hidden w-full p-4 pt-5 text-center">
                    <p class="text-gray-300">Referral Bonus: 
                        <span id="referral-bonus-display" class="font-bold text-lg text-green-400">+0%</span>
                    </p>
                    <button id="claim-final-btn" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all">
                        Claim Final Discount
                    </button>
                </div>

                <div id="referral-section" class="hidden w-full p-4 pt-6 border-t border-gray-600">
                    <h4 class="text-lg font-bold text-white">Share for more discount!</h4>
                    <p class="text-gray-400 text-sm mb-3">Get +0.5% for each friend who completes the tasks!</p>
                    <div class="relative flex items-center">
                        <input type="text" id="referral-link-display" readonly class="w-full bg-gray-800 border border-gray-600 text-gray-300 text-sm rounded-lg p-3 pr-24" value="">
                        <button id="copy-link-btn" class="absolute right-1 top-1/2 -translate-y-1/2 bg-red-600 hover:bg-red-700 text-white font-bold text-sm py-2 px-3 rounded-md transition-all">Copy</button>
                    </div>
                    <p id="copy-feedback" class="text-green-400 text-xs mt-2 h-4"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Final Discount Modal for User A -->
    <div id="final-discount-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 text-center">
        <div id="final-discount-card" class="bg-gray-900 rounded-3xl p-8 shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl sm:text-4xl font-bold text-white mb-4">Your Final Discount Is...</h2>
            <div id="final-discount-animation" class="text-7xl sm:text-8xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 my-4">0%</div>
            <p id="final-discount-code" class="text-xl sm:text-2xl font-mono bg-gray-800 text-red-300 px-6 py-3 rounded-lg border border-gray-700 inline-block"></p>
            <p class="text-gray-400 mt-6 text-sm">Show this code to the cashier.</p>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot, serverTimestamp, collection, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyA1Ln95FA7TLhZRFPjk76mRgfzGtKGy71k",
                authDomain: "scratchcard-e789d.firebaseapp.com",
                projectId: "scratchcard-e789d",
                storageBucket: "scratchcard-e789d.appspot.com",
                messagingSenderId: "1020798468185",
                appId: "1:1020798468185:web:2d8ded5ca4ccc0842f148"
            };

            const config = {
                restaurantName: "Hotel Khandesh Wada",
                logoUrl: "kw.PNG",
                tasks: [
                    { name: "Google Review", description: "Leave us a review on Google", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="text-red-500"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12.5C5,8.75 8.36,5.73 12.19,5.73C15.19,5.73 17.55,6.82 17.55,6.82L19.43,5C19.43,5 17.55,3 12.19,3C6.42,3 2.03,7.8 2.03,12.5C2.03,17.2 6.42,22 12.19,22C17.6,22 21.7,18.35 21.7,12.91C21.7,12.16 21.55,11.6 21.35,11.1Z"/></svg>`, url: "https://maps.app.goo.gl/SggpAD2sniLMkmeu6" },
                    { name: "Instagram Follow", description: "Follow us on Instagram", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stroke-red-500"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>`, url: "https://www.instagram.com/hotelkhandeshwadajalgaon?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" }
                ],
                sessionMinutes: 9999, // Link timeout removed for testing
                revealThreshold: 0.3 
            };

            const elements = {
                mainContent: document.getElementById('main-content'),
                loadingSpinner: document.getElementById('loading-spinner'),
                userDetailsSection: document.getElementById('user-details-section'),
                userDetailsForm: document.getElementById('user-details-form'),
                tasksSection: document.getElementById('tasks-section'),
                getCardButtonSection: document.getElementById('get-card-button-section'),
                getCardBtn: document.getElementById('get-card-btn'),
                boostFriendSection: document.getElementById('boost-friend-section'),
                boostBtn: document.getElementById('boost-btn'),
                infoSection: document.getElementById('info-section'),
                infoTitle: document.getElementById('info-title'),
                infoMessage: document.getElementById('info-message'),
                infoCode: document.getElementById('info-code'),
                headerSection: document.getElementById('header-section'),
                headerSubtitle: document.getElementById('header-subtitle'),
                scratchModalOverlay: document.getElementById('scratch-modal-overlay'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                canvas: document.getElementById('scratch-card-canvas'),
                resultText: document.getElementById('result-text'),
                initialDiscountDisplay: document.getElementById('initial-discount-display'),
                bonusSection: document.getElementById('bonus-section'),
                referralBonusDisplay: document.getElementById('referral-bonus-display'),
                claimFinalBtn: document.getElementById('claim-final-btn'),
                referralSection: document.getElementById('referral-section'),
                referralLinkDisplay: document.getElementById('referral-link-display'),
                copyLinkBtn: document.getElementById('copy-link-btn'),
                copyFeedback: document.getElementById('copy-feedback'),
                finalDiscountModal: document.getElementById('final-discount-modal'),
                finalDiscountCard: document.getElementById('final-discount-card'),
                finalDiscountAnimation: document.getElementById('final-discount-animation'),
                finalDiscountCode: document.getElementById('final-discount-code'),
            };
            
            let db, auth;
            let tasksState = [];
            let currentSessionData = null;
            let unsubscribeSession;
            let firebaseReady = false;

            function getLocalId(key) { return localStorage.getItem(key); }
            function setLocalId(key, id) { localStorage.setItem(key, id); }

            async function init() {
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session');

                if (sessionId) {
                    history.replaceState(null, '', window.location.pathname);
                    showTaskScreen("Help your friend get a bigger discount by completing these tasks!");
                    initFirebase().then(() => {
                        setupReferredUserFlow(sessionId);
                    });
                } else {
                    showMainUserFlow();
                    initFirebase(); // Initialize in background
                }
            }

            function showMainUserFlow() {
                showScreen('userDetailsSection');
                elements.userDetailsForm.addEventListener('submit', handleUserSubmit);
            }

            async function handleUserSubmit(e) {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="animate-spin inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full" role="status"></span>`;

                if (!firebaseReady) {
                    console.log("Waiting for Firebase to initialize...");
                    await initFirebase(); // Ensure it's ready before proceeding
                }

                const userName = document.getElementById('user-name').value;
                const userContact = document.getElementById('user-contact').value;
                const userId = userContact;
                setLocalId('userId', userId);
                
                try {
                    const userRef = doc(db, 'users', userId);
                    await setDoc(userRef, {
                        name: userName,
                        contact: userContact,
                        claimed: false,
                        createdAt: serverTimestamp()
                    });
                    showTaskScreen("Complete a couple of tasks to unlock a surprise discount!");
                } catch (error) {
                    console.error("Failed to save user data:", error);
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                }
            }

            async function setupReferredUserFlow(sessionId) {
                if (!firebaseReady) {
                    showInfoScreen("Connecting...", "Please wait while we validate the link.");
                    return; // Firebase will call this again when ready
                }
                const sessionRef = doc(db, 'sessions', sessionId);
                const sessionSnap = await getDoc(sessionRef);

                if (!sessionSnap.exists()) {
                    showInfoScreen("Link Not Found", "This referral link doesn't seem to be valid.");
                    return;
                }

                const sessionData = sessionSnap.data();
                const minutesSinceCreated = (Date.now() - sessionData.createdAt.toDate()) / 60000;

                if (minutesSinceCreated > config.sessionMinutes) {
                    showInfoScreen("Link Expired", `This referral link has expired.`);
                    return;
                }
                
                setLocalId('sessionId', sessionId);
                // Task screen is already showing, this just confirms it's valid.
            }

            function showTaskScreen(subtitle) {
                showScreen('headerSection');
                elements.headerSubtitle.textContent = subtitle;
                elements.tasksSection.classList.remove('hidden');
                buildTasks();
            }

            function buildTasks() {
                elements.tasksSection.innerHTML = '';
                document.getElementById('restaurant-name').textContent = config.restaurantName;
                document.getElementById('logo').src = config.logoUrl;
                document.getElementById('logo-top').src = config.logoUrl;
                tasksState = config.tasks.map(() => false);

                config.tasks.forEach((task, index) => {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'task-item bg-gray-800/80 p-4 border border-gray-700 rounded-xl flex items-center justify-between transition-all hover:shadow-md hover:border-red-500 cursor-pointer';
                    if (index > 0) taskEl.classList.add('task-item-locked');
                    taskEl.innerHTML = `
                        <div class="flex items-center text-left flex-grow pointer-events-none">
                            <div class="mr-4">${task.icon}</div>
                            <span class="text-gray-200 font-medium task-description">${task.description}</span>
                        </div>
                        <input type="checkbox" data-index="${index}" class="h-6 w-6 rounded-md border-gray-600 text-red-600 focus:ring-red-500 cursor-not-allowed" disabled>`;
                    elements.tasksSection.appendChild(taskEl);
                    taskEl.addEventListener('click', (e) => {
                        if (taskEl.classList.contains('task-item-locked')) return;
                        const checkbox = taskEl.querySelector('input[type="checkbox"]');
                        if (checkbox.disabled) {
                            checkbox.disabled = false;
                            checkbox.classList.remove('cursor-not-allowed');
                        }
                        if (e.target.type !== 'checkbox') window.open(task.url, '_blank');
                    });
                });
                document.querySelectorAll('#tasks-section input[type="checkbox"]').forEach(cb => cb.addEventListener('change', handleCheckboxChange));
            }
            
            function handleCheckboxChange(event) {
                const index = parseInt(event.target.dataset.index);
                tasksState[index] = event.target.checked;
                event.target.closest('.task-item').classList.toggle('task-item-completed', event.target.checked);
                
                const allTaskItems = document.querySelectorAll('.task-item');
                if (event.target.checked) {
                    const nextTaskItem = allTaskItems[index + 1];
                    if (nextTaskItem) nextTaskItem.classList.remove('task-item-locked');
                } else {
                    for (let i = index + 1; i < allTaskItems.length; i++) {
                         allTaskItems[i].classList.add('task-item-locked');
                    }
                }
                
                if (tasksState.every(s => s === true)) {
                    setTimeout(() => {
                        elements.tasksSection.classList.add('hidden');
                        const sessionId = getLocalId('sessionId');
                        if (sessionId) {
                            elements.boostFriendSection.classList.remove('hidden');
                        } else {
                            elements.getCardButtonSection.classList.remove('hidden');
                        }
                    }, 500);
                }
            }
            
            async function handleGetCard() {
                elements.scratchModalOverlay.classList.remove('hidden');
                
                const initialDiscount = Math.floor(Math.random() * 3) + 3; 
                const discountCode = `PROMO-${Date.now().toString(36).slice(-4).toUpperCase()}`;

                const sessionRef = await addDoc(collection(db, 'sessions'), {
                    initialDiscount: initialDiscount,
                    referralBonus: 0,
                    discountCode: discountCode,
                    ownerId: getLocalId('userId'),
                    createdAt: serverTimestamp()
                });
                
                setLocalId('sessionId', sessionRef.id);
                setupScratchCard(initialDiscount, sessionRef.id);
            }

            async function handleClaimFinalDiscount() {
                if (!currentSessionData) return;
                const finalDiscount = (currentSessionData.initialDiscount || 0) + (currentSessionData.referralBonus || 0);

                hideScratchModal();
                elements.finalDiscountModal.classList.remove('hidden');
                elements.finalDiscountModal.classList.add('modal-show');
                elements.finalDiscountCard.classList.add('result-reveal');

                const animationDuration = 1500;
                let frame = 0;
                const totalFrames = Math.round(animationDuration / (1000/60));
                const counter = () => {
                    frame++;
                    const progress = frame / totalFrames;
                    const currentValue = finalDiscount * progress;
                    elements.finalDiscountAnimation.textContent = `${currentValue.toFixed(1)}%`;
                    if (frame < totalFrames) requestAnimationFrame(counter);
                    else elements.finalDiscountAnimation.textContent = `${finalDiscount.toFixed(1)}%`;
                };
                requestAnimationFrame(counter);
                
                elements.finalDiscountCode.textContent = currentSessionData.discountCode;
                
                const userRef = doc(db, 'users', getLocalId('userId'));
                await updateDoc(userRef, { 
                    claimed: true, 
                    discountCode: currentSessionData.discountCode,
                    finalDiscount: parseFloat(finalDiscount.toFixed(1))
                });
                
                const sessionRef = doc(db, 'sessions', getLocalId('sessionId'));
                await deleteDoc(sessionRef);

                if (unsubscribeSession) unsubscribeSession();
                localStorage.removeItem('sessionId');
            }

            async function handleBoost() {
                const sessionId = getLocalId('sessionId');
                const sessionRef = doc(db, 'sessions', sessionId);
                await updateDoc(sessionRef, { referralBonus: increment(0.5) });
                showInfoScreen("Thank You!", "Your friend's discount has been boosted!");
                localStorage.removeItem('sessionId');
            }

            function setupScratchCard(discount, sessionId) {
                elements.initialDiscountDisplay.textContent = `${discount}% OFF`;
                
                const sessionRef = doc(db, 'sessions', sessionId);
                if (unsubscribeSession) unsubscribeSession();

                unsubscribeSession = onSnapshot(sessionRef, (docSnap) => {
                    if (docSnap.exists()){
                        currentSessionData = docSnap.data();
                        const bonus = currentSessionData.referralBonus || 0;
                        elements.referralBonusDisplay.textContent = `+${bonus.toFixed(1)}%`;
                    }
                });

                const canvas = elements.canvas;
                const ctx = canvas.getContext('2d');
                // Scratch card drawing logic...
            }
            
            function showInfoScreen(title, message, code = '') {
                elements.infoTitle.textContent = title;
                elements.infoMessage.textContent = message;
                if (code) {
                    elements.infoCode.textContent = code;
                    elements.infoCode.classList.remove('hidden');
                } else {
                    elements.infoCode.classList.add('hidden');
                }
                showScreen('infoSection');
            }
            
            function hideScratchModal() { elements.scratchModalOverlay.classList.add('hidden'); }
            
            function copyReferralLink() {
                navigator.clipboard.writeText(elements.referralLinkDisplay.value).then(() => {
                    elements.copyFeedback.textContent = 'Copied!';
                    setTimeout(() => elements.copyFeedback.textContent = '', 2000);
                });
            }

            async function initFirebase() {
                if (firebaseReady) return true;
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    await signInAnonymously(auth);
                    firebaseReady = true;
                    return true;
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    let message = "Could not connect to Firebase. Please check the console.";
                    if (error.code === 'auth/configuration-not-found') {
                         message = "Configuration Error: Please enable Anonymous Authentication in your Firebase project's console.";
                    }
                    showInfoScreen("Connection Error", message);
                    return false;
                }
            }

            function showScreen(screen) {
                ['loadingSpinner', 'userDetailsSection', 'headerSection', 'tasksSection', 'getCardButtonSection', 'boostFriendSection', 'infoSection'].forEach(s => {
                    if (elements[s]) { elements[s].classList.add('hidden'); }
                });
                if (elements[screen]) { elements[screen].classList.remove('hidden'); }
            }
            
            elements.getCardBtn.addEventListener('click', handleGetCard);
            elements.boostBtn.addEventListener('click', handleBoost);
            elements.closeModalBtn.addEventListener('click', hideScratchModal);
            elements.copyLinkBtn.addEventListener('click', copyReferralLink);
            elements.claimFinalBtn.addEventListener('click', handleClaimFinalDiscount);
            
            init();
        });
    </script>
</body>
</html>

